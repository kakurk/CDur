---
title: "Memory Cue Duration and Directed Forgetting"
author: "Kyle Kurkela and Nancy Dennis"
date: '`r Sys.Date()`'
output: 
  html_notebook:
    code_folding: hide  
    toc: true
    toc_float: true
params:
  datapath: C:\Users\kylea\OneDrive\Desktop\CDur\data\
---

# Loading Libraries

For the purposes of this notebook, I will be using the `tidyverse` and `knitr` packages.

```{r libraries, message=FALSE, warning=FALSE}
library('tidyverse')
library('knitr')
library('emmeans')
library('kableExtra')
library('magrittr')
library('afex')
```

# Load Data

Load the raw data into R from the datapath directory input at the top of the notebook.

```{r load}
# Initialize variables
datapath           <- params$datapath
ya_raw_data_file   <- paste0(datapath, "ya_raw_data.csv")
oa_raw_data_file   <- paste0(datapath, "oa_raw_data.csv")
demo_raw_data_file <- paste0(datapath, "demographics.csv")

# Load data into dataframes
df.young        <- read.csv(ya_raw_data_file, quote = "\'")
df.old          <- read.csv(oa_raw_data_file, quote = "\'")
df.demographics <- read.csv(demo_raw_data_file, quote = "\'")

# Remove problem subjects o322, o122, and o307
df.old          <- filter(df.old, subject != 'o322')
df.old          <- filter(df.old, subject != 'o122')
df.old          <- filter(df.old, subject != 'o307')

df.demographics <- filter(df.demographics, SUBJECT != 'o322')
df.demographics <- filter(df.demographics, SUBJECT != 'o122')
df.demographics <- filter(df.demographics, SUBJECT != 'o307')
```

# Data Cleaning

## Demographics

In this section of the notebook, we will be cleaning up the demographics data by:  

1. Droping empty variables.  
2. Creating the `EDUCATION_yrs` variable, which calculates the `EDUCATION` variable in terms of years of schooling.  
3. Forcing the `AGE` and `SEX` variables to follow the all capitialization variable naming convention of this notebook.  
4. Compute the composite `BASELINE_COGITIVE_ABILITY` variable by calculating the mean (rounded to 2 decimal points) of the each subject's Symbol Search, Digit-Symbol, Arithmetic, Letter-Number Sequencing, and Vocabulary scores. 

```{r clean_demographics_data}
# dropping blank variables; creating EDUCTION_yrs
df.demographics %>%
  select(-X, -X.1) %>%
  mutate(EDUCATION_yrs = ifelse(EDUCATION == '8th grade', 8,
                         ifelse(EDUCATION == '9th grade', 9, 
                         ifelse(EDUCATION == '10th grade', 10,
                         ifelse(EDUCATION == '11th grade', 11,
                         ifelse(EDUCATION == '12th grade', 12,
                         ifelse(EDUCATION == '1 yr college' | 
                                EDUCATION == '1 Year college' | 
                                EDUCATION == '1 year college', 13,
                         ifelse(EDUCATION == '2 yrs college' | 
                                EDUCATION == '2 Years college' | 
                                EDUCATION == '2 years college', 14,
                         ifelse(EDUCATION == '3 yrs college' | 
                                EDUCATION == '3 Years college' | 
                                EDUCATION == '3 years college', 15,
                         ifelse(EDUCATION == '4 yrs college' | 
                                EDUCATION == '4 Years college' | 
                                EDUCATION == '4 years college', 16,
                         ifelse(EDUCATION == 'Post-grad work', 17,
                         ifelse(EDUCATION == 'Masters', 18,
                         ifelse(EDUCATION == 'Doctoral', 20, NA)))))))))))),
         Sex = ifelse(Sex == 'F', 'Female', 
               ifelse(Sex == 'M', 'Male', NA))) -> df.demographics 

# Force Age and Sex variables into the all capitalization variable name convention
colnames(df.demographics)[10:11] <- c("AGE", "SEX")

# Calculating Cognitive Assessment Composite Score
df.demographics %>%
  rowwise() %>%
  mutate(BASELINE_COGITIVE_ABILITY = mean(c(SYMBOLSEARCH, 
                                            DIGITSYMBOL, 
                                            DIGITSPAN, 
                                            ARITHMETIC, 
                                            LNSEQUENCING, 
                                            VOCAB), na.rm = TRUE),
         BASELINE_COGITIVE_ABILITY = round(BASELINE_COGITIVE_ABILITY, digits = 2)) %>%
  ungroup() -> df.demographics

# Calculate the Composite Z score
CompositeVars <- c('SYMBOLSEARCH', 'DIGITSYMBOL', 'DIGITSPAN', 'ARITHMETIC', 'LNSEQUENCING', 'VOCAB')

df.demographics %>%
  mutate(AgeGroup = str_extract(string = SUBJECT, pattern = '^[yo]'),
         AgeGroup = factor(AgeGroup, 
                           levels = c('y', 'o'), 
                           labels = c('Young Adults', 'Old Adults'))) %>%
  group_by(AgeGroup) %>%
  mutate_at(CompositeVars, scale) %>%
  ungroup() %>%
  mutate(COMPOSITEZSCORE = pmap_dbl(select(., one_of(CompositeVars)), lift_vd(mean))) -> df.demographics.z
```

## Raw Experimental Data

In this section of the notebook we will be cleaning the raw experimental data by:  

1. Concatenating the young and old data and creating a new variable `AgeGroup`.    
2. Dropping the extra jitter varaiable.  
3. Making the numeric coding of variables `enctype`, `score`, `Response`, `type`, and `AgeGroup` into factors with informative level names.  

```{r concatenate_and_clean, warning=FALSE}
# concatenate
df.all <- bind_rows(list(df.young, df.old), .id = "AgeGroup")

# clean
df.all %>%
  select(-jit.1) %>% # dropping extra jitter
  mutate(
    enctype  = ifelse(enctype == 1, '1 Second',
               ifelse(enctype == 3, '3 Seconds', 
               ifelse(enctype == 5, '5 Seconds', 'Lure'))),
    enctype  = factor(enctype),
    score    = ifelse(score == 1, 'Remember',
               ifelse(score == 2, 'Know',
               ifelse(score == 3, 'New', 'No Response'))),
    score    = factor(score),
    Response = ifelse(Response == 2, 'B Key',
               ifelse(Response == 22, 'V Key',
               ifelse(Response == 14, 'N Key', 'No Response'))),
    Response = factor(Response),
    type     = ifelse(type == 0, 'To Be Forgotten', 
               ifelse(type == 1, 'To Be Remembered', 'Lure')),
    type     = factor(type),
    AgeGroup = ifelse(AgeGroup == 1, 'Young', 
               ifelse(AgeGroup == 2, 'Old', NA)),
    AgeGroup = factor(AgeGroup)
  ) -> df.all
```

# Table 1: Demographics Summary

```{r demographics_summary, warning=FALSE}

# take the demographics data frame and tidy it
df.demographics %>%
  mutate(AgeGroup = str_extract(SUBJECT, '^[oy]'),
         AgeGroup = factor(AgeGroup, 
                           levels = c('y', 'o'), 
                           labels = c('Younger Adults', 'Old Adults'))) %>%
  select(-SUBJECT) -> df.demographics.tidy

df.demographics.tidy %>%
  group_by(AgeGroup) %>%
  summarise_if(is.numeric, c('mean', 'sd'), na.rm = T) %>%
  mutate_if(is.numeric, round, digits = 2) %>%
  pivot_longer(names_to='Measure', values_to = 'value', -AgeGroup, values_drop_na = T) %>%
  separate(col = Measure, sep = '_(?=(sd)|(mean))', into = c('Measure', 'statistic')) %>% 
  pivot_wider(names_from = statistic, values_from = value) %>%
  mutate(cellvalue = str_c(mean, ' (', sd, ')')) %>% 
  select(-mean, -sd) %>%
  pivot_wider(names_from = 'AgeGroup', values_from = 'cellvalue') %>% 
  mutate(Measure = recode(Measure, 
                          'EDUCATION_yrs' = 'EDUCATION',
                          'BASELINE_COGITIVE_ABILITY' = 'COMPOSITE')) -> table1.demographics

df.demographics.tidy %>%
  mutate_at('SEX', ~recode(.x, 'Female' = 1, 'Male' = 0)) %>%
  rename('FEMALE' = 'SEX') %>%
  group_by(AgeGroup) %>%
  summarise_at('FEMALE', sum) %>%
  pivot_longer(FEMALE, names_to = 'Measure', values_to = 'cellvalue') %>%
  mutate_at('cellvalue', as.character) %>%
  pivot_wider(names_from = AgeGroup, values_from = cellvalue) -> FEMALE

df.demographics.tidy %>%
  group_by(AgeGroup) %>%
  summarise(N = n()) %>%
  pivot_longer(N, names_to = 'Measure', values_to = 'cellvalue') %>%
  mutate_at('cellvalue', as.character) %>%
  pivot_wider(names_from = AgeGroup, values_from = cellvalue) -> NN
  
# Display the Table
bind_rows(table1.demographics, FEMALE, NN) %>%
  slice(c(12,7,11,8,10,1:6,9)) %>%
  mutate(`Younger Adults` = if_else(is.na(`Younger Adults`), 
                                    str_c('NA', footnote_marker_alphabet(1)), 
                                    as.character(`Younger Adults`))) -> table1.demographics

names(table1.demographics)[2] <- str_c(names(table1.demographics)[2], footnote_marker_symbol(1))

table1.demographics %>%
  kable(format = 'html', 
        booktabs = T,
        escape = F, 
        caption = 'Table 1: Participant Demographics') %>%
  kable_styling() %>%
  footnote(general_title ='\n\nTable 1. ',
           general = 'mean (sd). N = size of sample, AGE = age in years , FEMALE = number of female participants, EDUCATION = years of education. See text for description of the cognitive assessment measures and the calculation of the composite score.\n\n', 
           symbol = 'Two younger adults did not complete the cognitive assessment battery. Means and standard deviations based on the Cognitive Assessment battery reflect 28 complete datasets.',
           alphabet = 'Younger adults were not required to complete the MMSE as part of the cognitive assessment battery.',
           footnote_as_chunk = T, 
           title_format = 'bold')
```

# DF-Effect

The first question we want to answer statistically: Do we see the `Directed-Forgetting Effect` in ANY of our experimental conditions?

First, lets calculate the `Directed-Forgetting Effect`:  

```{r DF_calculations}
# Calculate the miss rates
df.all %>%
  filter(enctype != "Lure") %>%
  mutate(enctype = factor(enctype)) %>%
  group_by(AgeGroup, enctype, type, subject) %>%
  summarize(MissRate = mean(score == "New")) %>% ungroup() -> df.missrates

# Break the dataframe into TBF and TBR
df.missrates %>% filter(type == "To Be Forgotten") %>% select(-type) -> TBF.Forgotten
df.missrates %>% filter(type == "To Be Remembered") %>% select(-type) -> TBR.Forgotten

# Merge join the TBF and TBR data frames together, making a "wide" dataframe
df.DFeffects <- left_join(TBF.Forgotten, TBR.Forgotten, 
                          by = c('AgeGroup','enctype', 'subject'), 
                          suffix = c("TBF", "TBR"))

# Calculate the DF-Effect
df.DFeffects %>%
  transmute(
    AgeGroup = AgeGroup,
    enctype = enctype,
    subject = subject,
    DF.effect = MissRateTBF - MissRateTBR) -> df.DFeffects
```

## Figure 1: Directed Forgetting Results

```{r}
# A Visual
df.DFeffects %>%
  group_by(enctype, AgeGroup) %>%
  summarize(meanDF.effect = mean(DF.effect), semDF.effect = sd(DF.effect)/sqrt(n())) %>%
  ggplot(aes(x = AgeGroup, y = meanDF.effect, group = enctype, fill = enctype)) + 
  geom_bar(stat="identity", position = position_dodge(width = .95)) + 
  geom_errorbar(aes(ymin = meanDF.effect - semDF.effect, 
                    ymax = meanDF.effect + semDF.effect), 
                width = 0.2, 
                position = position_dodge(width = .95)) + 
  scale_fill_brewer(palette = "Set2") + 
  scale_y_continuous(limits = c(0, NA), expand = c(0, 0, .05, 0)) + 
  ggtitle("Directed Forgetting Effect") + 
  ylab("Effect Size") + 
  xlab("Age Group") + 
  labs(fill = 'Cue Duration') +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.ticks.x = element_blank(), 
        axis.text.x = element_text(size = 12)) -> p

p
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggsave('C:\\Users\\kylea\\OneDrive\\Desktop\\CDur\\figures\\Figure3.png', 
      dpi = 300, 
      width = 7,
      height = 5,
      units = 'in')
```

The **Age Group x Cue Duration ANOVA** table:  

```{r ANOVA, message=FALSE}
# ANOVA
ANOVA <- aov(DF.effect ~ AgeGroup * enctype + Error(subject/enctype), data = df.DFeffects)
 
summary(ANOVA)
```
The "separate t-tests" way:  

```{r, warning=FALSE}
# average over the cue duration conditions
# run a one-sample t-test separately for OAs and YAs 
df.DFeffects %>% 
  group_by(AgeGroup, subject) %>% 
  summarise(DF.effect = mean(DF.effect)) %>% 
  group_by(AgeGroup) %>% 
  nest() %>% 
  mutate(TESTRES = map(data, ~t.test(formula = DF.effect ~ 1, data = .x, alternative = 'greater') %>% broom::tidy())) %>% 
  unnest(TESTRES) %>% 
  select(-data)
```

Using `emmeans` and pooled error variance estimate, calculating the one sample t-test of each mean in the graph above with zero:  

```{r, message=FALSE}
# Is the mean DF-effect within each Age Group collapsed across Cue Duration significantly different from 0?
emmeans(ANOVA, ~ AgeGroup) %>% 
  test(side = '>', adj = 'bonferroni')
```

```{r message=FALSE}
# Is there a Directed Forgetting Effect > 0 for each AgeGroup | Cue Duration?

require(emmeans)
emmeans(ANOVA, ~ enctype + AgeGroup) -> EMMEANS.DF

summary(EMMEANS.DF, digits = 2, infer = T, adjust = 'bonferroni', side = '>')
```

```{r}
# All pairwise comparisons, within each age group
pairs(EMMEANS.DF, by = 'AgeGroup')
```

Testing the linear and quadratic trends within each Age Group:

```{r}
# Is there a linear effect, a quadratic effect, or a 'plateau' effect?

contrast(EMMEANS.DF, method = 'poly', by = 'AgeGroup')
```

Comparing the linear and quadratic effects **across Age Groups**:  

```{r}
# Is there a difference in the linear / quadratic effects for YAs and OAs?
custom_con.emmc <- function(levels){
  data.frame(`linear` = c(-1, 0, 1),
             `pleatau` = c(-2, 1, 1))
}

contrast(EMMEANS.DF, interaction = c('custom_con', 'consec'))
```

```{r}
df.DFeffects %>%
  mutate(enctype.L = recode(enctype, 
                            `1 Second` = -1,
                            `3 Seconds` = 0,
                            `5 Seconds` = 1),
         enctype.P = recode(enctype, 
                            `1 Second` = -1,
                            `3 Seconds` = .5,
                            `5 Seconds` = .5)) -> DATA

Linear.Model  <- lm(DF.effect ~ enctype.L, data = DATA, subset = DATA$AgeGroup == 'Young')
Pleatau.Model <- lm(DF.effect ~ enctype.P, data = DATA, subset = DATA$AgeGroup == 'Young')

bind_rows(broom::glance(Linear.Model), broom::glance(Pleatau.Model), .id = 'model') %>%
  mutate(model = factor(model, levels = c(1,2), labels = c('Linear', 'Pleatau'))) %>%
  select(model, r.squared, AIC, everything())
```

```{r}
df.DFeffects %>%
  mutate(enctype.L = recode(enctype, 
                            `1 Second` = -1,
                            `3 Seconds` = 0,
                            `5 Seconds` = 1),
         enctype.P = recode(enctype, 
                            `1 Second` = -1,
                            `3 Seconds` = .5,
                            `5 Seconds` = .5)) -> DATA

Linear.Model  <- lm(DF.effect ~ enctype.L, data = DATA, subset = DATA$AgeGroup == 'Old')
Pleatau.Model <- lm(DF.effect ~ enctype.P, data = DATA, subset = DATA$AgeGroup == 'Old')

bind_rows(broom::glance(Linear.Model), broom::glance(Pleatau.Model), .id = 'model') %>%
  mutate(model = factor(model, levels = c(1,2), labels = c('Linear', 'Pleatau'))) %>%
  select(model, r.squared, AIC, everything())
```

## Figure 2: Directed Forgetting and Cog Assess Composite

What do our results look like when we consider baseline cognitive assessment score?

```{r Visual, warning=FALSE}
cog.assess.composites <- select(df.demographics.z, SUBJECT, COMPOSITEZSCORE)
cog.assess.composites <- transmute(cog.assess.composites, subject = SUBJECT, 
                                   composite = COMPOSITEZSCORE)

df.DFeffects <- left_join(df.DFeffects, cog.assess.composites, by = "subject")

df.DFeffects %>% 
  filter(AgeGroup == 'Old') %>%
  ggplot(aes(y = DF.effect, x = composite, colour = AgeGroup)) + 
    scale_colour_brewer(palette = "Set2", guide = FALSE) + 
    geom_point() + 
    facet_grid(. ~ enctype) + 
    geom_smooth(method = "lm", 
                formula = y ~ x, 
                se = TRUE, 
                colour = "navyblue", 
                linetype = "longdash") +
  labs(y = 'Effect Size',
       x = 'Composite Cognitive Assessment Score',
       title = 'Individual Differences Among Older Adults',
       subtitle = 'Directed Forgetting Effect')
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggsave('C:\\Users\\kylea\\OneDrive\\Desktop\\CDur\\figures\\Figure5.png', 
      dpi = 300, 
      width = 7,
      height = 5,
      units = 'in')
```

A regression of DF.effect on Cue Duration and Composite Cog Assess Score within OAs only:  

```{r regression}
# Is there an interaction between AgeGroup and Composite Cog Assess score?
OAonly.df <- df.DFeffects %>% filter(AgeGroup == 'Old')

ANCOVA <- aov(DF.effect ~ enctype*composite + Error(subject/enctype),
              data = OAonly.df)

summary(ANCOVA)
```

```{r, message=FALSE, warning=FALSE}
# evaluate the trends
emtrends(ANCOVA, 
         pairwise ~ enctype, 
         var = 'composite') %>%
  test(adjust = 'bonferroni')
```

```{r, warning=FALSE, message=FALSE}
# A custom contast, comparing one and three seconds conditions with the 5 second condition
custom_con.emmc <- function(levels){
  data.frame(`onethree_v_five` = c(-.5, -.5, 1))
}

# evaluate the trends
emtrends(ANCOVA, 
         custom_con ~ enctype, 
         var = 'composite')
```

```{r, warning=FALSE, message=FALSE}
M           <- mean(OAonly.df$composite)
SD          <- sd(OAonly.df$composite)
M.plus.1SD  <- M + SD
M.minus.1SD <- M - SD

emmeans(ANCOVA, ~ enctype | composite, 
        at = list(composite = c(M.minus.1SD, M, M.plus.1SD))) %>%
  as.data.frame() %>%
  mutate_at('composite', factor, labels = c('M - 1SD', 'M', 'M + 1SD')) -> EMMEANS.at.CovLevels

ggplot(EMMEANS.at.CovLevels, 
       aes(x = enctype, 
           y = emmean, 
           ymax = upper.CL, 
           ymin = lower.CL, 
           fill = enctype)) +
  geom_col() +
  scale_fill_brewer(palette = "Set2") + 
  geom_errorbar(width = .2) +
  facet_grid(~composite, labeller = label_both) +
  labs(title = 'Individual Differences in Directed Forgetting in Older Adults',
       subtitle = 'As a Function of Cognitive Reserve',
       y = 'Estimate Effect Size',
       x = 'Cue Duration',
       fill = 'Cue Duration') +
    theme(axis.ticks.x = element_blank(), 
          axis.text.x = element_blank(),
          axis.title.x = element_blank())
```

```{r}
ggsave('C:\\Users\\kylea\\OneDrive\\Desktop\\CDur\\Figure5-alt.png', 
      dpi = 300, 
      width = 7,
      height = 5,
      units = 'in')
```

# Rec Effect

A second question we would like to answer is this: is there a significant `Recollection Effect`? The Recollection Effects operationalized as:  

`TBR-Rec - TBF-Rec`

This measure is similar too, but different than, the DF-Effect.

First, lets calculate the recollection effects:  

```{r rec-effect_calculations}
# calculate the Rec rates
df.all %>%
  filter(enctype != "Lure") %>%
  mutate(enctype = factor(enctype)) %>%
  group_by(AgeGroup, enctype, type, subject) %>%
  summarize(RecRate = mean(score == "Remember")) %>% ungroup() -> df.recrates

# Break the dataframe into TBF and TBR
df.recrates %>% filter(type == "To Be Forgotten") %>% select(-type)  -> TBF.Remembered
df.recrates %>% filter(type == "To Be Remembered") %>% select(-type) -> TBR.Remembered

# Merge join the TBF and TBR data frames together, making a "wide" dataframe
df.RecEffects <- left_join(TBF.Remembered, TBR.Remembered, 
                           by = c('AgeGroup','enctype', 'subject'), 
                           suffix = c("TBF", "TBR"))

# Calculate the Rec-Effect
df.RecEffects %>%
  transmute(
    AgeGroup = AgeGroup,
    enctype = enctype,
    subject = subject,
    Rec.effect = RecRateTBR - RecRateTBF) -> df.RecEffects
```

## By Condition By Age Group

A visual of the results:  

```{r}
# A Visual
df.RecEffects %>%
  group_by(enctype, AgeGroup) %>%
  summarize(meanRec.effect = mean(Rec.effect), semRec.effect = sd(Rec.effect)/sqrt(n())) %>%
  ggplot(aes(x = AgeGroup, y = meanRec.effect, fill = enctype)) + 
  geom_bar(stat="identity", position = position_dodge(width = .95)) + 
  geom_errorbar(aes(ymin = meanRec.effect - semRec.effect, 
                    ymax = meanRec.effect + semRec.effect), 
                width = 0.2, 
                position = position_dodge(width = .95)) + 
  scale_fill_brewer(palette = "Set2") + 
  scale_y_continuous(limits = c(0, 0.2145549), expand = c(0, 0, .05, 0)) + 
  ggtitle("Recollection Effect") + 
  ylab("Effect Size") + xlab("Age Group") + 
  labs(fill = 'Cue Duration') +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.ticks.x = element_blank(), 
        axis.text.x = element_text(size = 12))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggsave('C:\\Users\\kylea\\OneDrive\\Desktop\\CDur\\figures\\Figure4.png', 
      dpi = 300, 
      width = 7,
      height = 5,
      units = 'in')
```

The **Age Group x Cue Duration ANOVA** table:  

```{r, warning=FALSE, message=FALSE}
# ANOVA
ANOVA <- aov(Rec.effect ~ AgeGroup * enctype + Error(subject/enctype), data = df.RecEffects)

# Summarize, break into between and repeated factors
summary(ANOVA)
```

```{r}
df.RecEffects %>%
  group_by(AgeGroup, subject) %>%
  summarise(Rec.effect = mean(Rec.effect)) %>%
  group_by(AgeGroup) %>%
  nest() %>%
  mutate(TESTRES = map(data, ~t.test(Rec.effect ~ 1, data = .x, alternative = 'greater') %>% broom::tidy())) %>%
  unnest(TESTRES) %>%
  select(-data)
```

```{r, message=FALSE}
# a prori tests against zero

require(emmeans)

emmeans(ANOVA, ~ AgeGroup) -> EMMEANS.RE

summary(EMMEANS.RE, infer = T, adjust = 'bonferroni', side = ">")
```

```{r message=FALSE}
# a prori tests against zero

require(emmeans)

emmeans(ANOVA, ~ enctype + AgeGroup) -> EMMEANS.RE

summary(EMMEANS.RE, infer = T, adjust = 'bonferroni', side = ">")
```

```{r}
# Is the linear effect statistically different from the quadratic effect?

contrast(EMMEANS.RE, method = list(linear = c(-1, 0, 1)),
         by = 'AgeGroup')
```

## With Cog Asses Score

How do the results change when we add cognitive assessment score as a factor into our ANOVA?

```{r, warning=FALSE}
# A Visual
cog.assess.composites <- select(df.demographics.z, SUBJECT, COMPOSITEZSCORE)
cog.assess.composites <- transmute(cog.assess.composites, subject = SUBJECT, 
                                   composite = COMPOSITEZSCORE)

df.RecEffects <- left_join(df.RecEffects, cog.assess.composites, by = "subject")

df.RecEffects %>%
  filter(AgeGroup == 'Old') %>%
ggplot(aes(y = Rec.effect, x = composite, colour = AgeGroup)) + 
  scale_colour_brewer(palette = "Set2") + 
  geom_point() + 
  facet_grid(. ~ enctype) + 
  geom_smooth(method = "glm", 
              se = TRUE, 
              formula = y ~ x, 
              colour = "navyblue", 
              linetype = "longdash") +
  labs(title = "Recollection Effects", 
       subtitle = "As a function of Cue Duration, Age Group, and Cog Assess Score") + 
  theme(plot.title = element_text(hjust = 0.5))
```

A regression model of Rec.effect predicted by Cur Duration and Composite Cog Assess score within OAs only:  

```{r}
# Is there an interaction between AgeGroup and composite Cog Assess score

ANCOVA <- aov_car(Rec.effect ~ enctype*composite + Error(subject/enctype), 
                  data = df.RecEffects %>% filter(AgeGroup == 'Old'), 
                  factorize = F, 
                  include_aov = T)

ANCOVA
```

```{r, warning=FALSE}
# evaluate the trends
emtrends(ANCOVA$aov, 
         trt.vs.ctrlk ~ enctype, 
         var = 'composite') %>%
  test(adjust = 'none')
```

```{r, warning=FALSE}
# A custom contast, comparing one and three seconds conditions with the 5 second condition
custom_con.emmc <- function(levels){
  data.frame(`onethree_v_five` = c(-1, -1, 2))
}

# evaluate the trends
emtrends(ANCOVA$aov, custom_con ~ enctype, var = 'composite') %>%
  test(adjust = 'none')
```